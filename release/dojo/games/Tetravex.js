/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


dojo.provide("games.Tetravex",null,{});dojo.require("dojox.gfx");dojo.require("dojox.gfx.move");dojo.require("dojo.io.script");dojo.require("games.tileData");games.Tetravex=function(){};games.Tetravex._props={suface_width:400,suface_height:200,padding:0};games.Tetravex.easy=false;games.Tetravex._boardX=[];games.Tetravex._boardY=[];games.Tetravex._half_square=0;games.Tetravex._tileSize=0;games.Tetravex._boardSize=2;games.Tetravex._surface=null;games.Tetravex.squares=[];games.Tetravex._tile=[];games.Tetravex._tileData=[];games.Tetravex._tileStopHandles=[];games.Tetravex._tileMoveHandles=[];games.Tetravex._origin={x:0,y:0};games.Tetravex._timeout=1000;var deferred=null;games.Tetravex.setPadding=function(_1){games.Tetravex._props.padding=_1;};games.Tetravex.setTileSize=function(_2){games.Tetravex._tileSize=_2;};games.Tetravex.initialize=function(_3){if(deferred instanceof dojo.Deferred){deferred.cancel();}deferred=games.Tetravex._xhrGameData();var _4=dojo.byId("tetravex");if(_3){console.debug("create suface");games.Tetravex._surface=dojox.gfx.createSurface(_4,games.Tetravex._props.suface_width,games.Tetravex._props.suface_height);}else{console.debug("clear surface");for(var i=0;i<games.Tetravex._tileMoveHandles.length;i++){dojo.disconnect(games.Tetravex._tileMoveHandles[i]);}for(var i=0;i<games.Tetravex._tileStopHandles.length;i++){dojo.disconnect(games.Tetravex._tileStopHandles[i]);}games.Tetravex._surface.clear();}games.Tetravex._surface.whenLoaded(function(){games.Tetravex._drawBoard();games.Tetravex._extendOnMoving();if(deferred.fired==0||deferred.fired==1){games.Tetravex._createTiles();}else{deferred.addCallback(function(_5){games.Tetravex._createTiles();return _5;});deferred.addErrback(function(_6){games.Tetravex._createTiles();return _6;});}});return;};games.Tetravex.reset=function(){games.Tetravex._tile=[];games.Tetravex.initialize(false);};games.Tetravex.resetPlus=function(){if(games.Tetravex._boardSize<5){games.Tetravex._boardSize++;games.Tetravex._tile=[];games.Tetravex.initialize(false);}};games.Tetravex.resetMinus=function(){if(games.Tetravex._boardSize>2){games.Tetravex._boardSize--;games.Tetravex._tile=[];games.Tetravex.initialize(false);}};games.Tetravex._xhrGameData=function(){return dojo.io.script.get({callbackParamName:"tileDataCallback",url:games.Tetravex.dataUrl,handleAs:"json",timeout:games.Tetravex._timeout,preventCache:true,content:{format:"json",size:games.Tetravex._boardSize},load:function(_7,_8){games.Tetravex._tileData=_7.n;return _7;},error:function(_9,_a){console.debug("failed xhrGet");games.Tetravex._tileData=games.Tetravex._localTileNumbers.n;return _9;}});};games.Tetravex._localTileNumbers={"n":[[1,1,1,1],[2,2,2,2],[3,3,3,3],[4,4,4,4]],"cs":null};games.Tetravex._drawBoard=function(){games.Tetravex._initGlobals();var _b=games.Tetravex._surface.createPath().setStroke("black");var i;for(i=0;i<=games.Tetravex._boardSize;i++){var x=games.Tetravex._boardX[0];var y=games.Tetravex._boardY[i];var h=games.Tetravex._boardX[games.Tetravex._boardSize];_b.moveTo(x,y);_b.hLineTo(h);_b.closePath();}for(i=0;i<=games.Tetravex._boardSize;i++){_b.moveTo(games.Tetravex._boardX[i],games.Tetravex._boardY[0]).vLineTo(games.Tetravex._boardY[games.Tetravex._boardSize]).closePath();}for(i=0;i<=games.Tetravex._boardSize;i++){_b.moveTo(games.Tetravex._boardX[games.Tetravex._boardSize+1],games.Tetravex._boardY[i]).hLineTo(games.Tetravex._boardX[(games.Tetravex._boardSize*2)+1]).closePath();}for(i=games.Tetravex._boardSize+1;i<=(games.Tetravex._boardSize*2)+1;i++){_b.moveTo(games.Tetravex._boardX[i],games.Tetravex._boardY[0]).vLineTo(games.Tetravex._boardY[games.Tetravex._boardSize]).closePath();}};games.Tetravex._initGlobals=function(){games.Tetravex._tileSize=games.Tetravex._props.suface_width/((2*games.Tetravex._boardSize)+2);games.Tetravex._half_square=(games.Tetravex._tileSize/2)+(games.Tetravex._props.padding);games.Tetravex._boardX=[];games.Tetravex._boardY=[];games.Tetravex._boardX[0]=games.Tetravex._tileSize/2;for(var f=1;f<(2*games.Tetravex._boardSize)+2;f++){games.Tetravex._boardX[f]=(games.Tetravex._tileSize/2)+((games.Tetravex._tileSize+games.Tetravex._props.padding*2)*(f));}for(var y=0;y<=games.Tetravex._boardSize;y++){games.Tetravex._boardY[y]=games.Tetravex._boardX[y];}};games.Tetravex._extendOnMoving=function(){dojo.extend(dojox.gfx.Moveable,{onMoving:function(_c,_d){if(_c.shape.matrix){if((_d.dx>0&&_c.shape.matrix.dx>(games.Tetravex._props.suface_width-games.Tetravex._tileSize-2))||(_d.dx<0&&_c.shape.matrix.dx<2)){_d.dx=0;}if((_d.dy<0&&_c.shape.matrix.dy<2)||(_d.dy>0&&_c.shape.matrix.dy>(games.Tetravex._props.suface_height-games.Tetravex._tileSize-2))){_d.dy=0;}}}});};games.Tetravex._createTiles=function(){var _e=0;for(var y=0;y<games.Tetravex._boardSize;y++){for(var x=1;x<=games.Tetravex._boardSize;x++){games.Tetravex._tile[_e]=_f(games.Tetravex._tileData[_e][0],games.Tetravex._tileData[_e][1],games.Tetravex._tileData[_e][2],games.Tetravex._tileData[_e][3],_e);console.debug(games.Tetravex._tile[_e].leftNum+" left and right nums set "+games.Tetravex._tile[_e].rightNum);games.Tetravex._tile[_e].applyLeftTransform({dx:games.Tetravex._boardX[games.Tetravex._boardSize+x]+(games.Tetravex._props.padding),dy:games.Tetravex._boardY[y]+(games.Tetravex._props.padding)});_e++;}}for(var t=0;t<games.Tetravex._tile.length;t++){var _10=[];_10[t]=new dojox.gfx.Moveable(games.Tetravex._tile[t]);games.Tetravex._tileMoveHandles[t]=dojo.connect(_10[t],"onFirstMove",null,(function(_11){return function(evt){_11.shape.moveToFront();games.Tetravex._origin.x=_11.shape.matrix.dx;games.Tetravex._origin.y=_11.shape.matrix.dy;console.clear();console.debug("reset for tile "+_11.shape.tileNumber);games.Tetravex._tile[_11.shape.tileNumber].tileAbove=null;games.Tetravex._tile[_11.shape.tileNumber].tileLeft=null;games.Tetravex._tile[_11.shape.tileNumber].tileBelow=null;games.Tetravex._tile[_11.shape.tileNumber].tileRight=null;console.debug("origin x:y "+games.Tetravex._origin.x+" : "+games.Tetravex._origin.y);};})(_10[t]));games.Tetravex._tileStopHandles[t]=dojo.connect(_10[t],"onMoveStop",null,(function(_12){return function(evt){console.debug("StopCalled ");games.Tetravex.moveToNearestSquare(_12);games.Tetravex._checkNeighbours(_12);games.Tetravex.checkForWin();};})(_10[t]));}function _f(_13,_14,_15,_16,_17){var _18=games.Tetravex._tileSize;var _19=games.Tetravex._tileSize/2;var _1a=games.Tetravex._surface.createGroup();var _1b=["black","#C17D11","#CC0000","#F57900","#EDD400","#73D216","#3465A4","#75507B","#BABDB6","white"];var _1c=["white","white","white","black","black","black","white","white","black","black"];var top=_1a.createPolyline([0,0,_18,0,_19,_19,0,0]);var _1d=_1a.createPolyline([0,0,_19,_19,0,_18,0,0]);var _1e=_1a.createPolyline([0,_18,_19,_19,_18,_18,0,_18]);var _1f=_1a.createPolyline([_18,_18,_19,_19,_18,0,_18,_18]);top.setFill(_1b[_13]).setStroke("black");_1d.setFill(_1b[_14]).setStroke("black");_1e.setFill(_1b[_15]).setStroke("black");_1f.setFill(_1b[_16]).setStroke("black");_1a.createText({x:(games.Tetravex._tileSize/2)-(0.4*games.Tetravex._tileSize/4),y:(games.Tetravex._tileSize/4)+(0.3*games.Tetravex._tileSize/4),text:_13}).setStroke(_1c[_13]).setFill(_1c[_13]).setFont({family:"sans-serif",size:games.Tetravex._tileSize/4+"pt"});_1a.createText({x:(games.Tetravex._tileSize/4)-(0.7*games.Tetravex._tileSize/4),y:(games.Tetravex._tileSize/2)+(0.5*games.Tetravex._tileSize/4),text:_14}).setStroke(_1c[_14]).setFill(_1c[_14]).setFont({family:"sans-serif",size:games.Tetravex._tileSize/4+"pt"});_1a.createText({x:(games.Tetravex._tileSize/2)-(0.4*games.Tetravex._tileSize/4),y:((games.Tetravex._tileSize/4)*3)+(0.7*games.Tetravex._tileSize/4),text:_15}).setStroke(_1c[_15]).setFill(_1c[_15]).setFont({family:"sans-serif",size:games.Tetravex._tileSize/4+"pt"});_1a.createText({x:((games.Tetravex._tileSize/4)*3)-(0.1*games.Tetravex._tileSize/4),y:(games.Tetravex._tileSize/2)+(0.5*games.Tetravex._tileSize/4),text:_16}).setStroke(_1c[_16]).setFill(_1c[_16]).setFont({family:"sans-serif",size:games.Tetravex._tileSize/4+"pt"});_1a.topNum=_13;_1a.leftNum=_14;_1a.bottomNum=_15;_1a.rightNum=_16;_1a.tileNumber=_17;return _1a;};};games.Tetravex.getTileByNumber=function(_20){for(var g=0;g<games.Tetravex._tile.length;g++){if(games.Tetravex._tile[g].tileNumber==_20){return games.Tetravex._tile[g];}}};games.Tetravex.moveToNearestSquare=function(_21){var _22=games.Tetravex._findNearestX(_21.shape.matrix.dx);var _23=games.Tetravex._findNearestY(_21.shape.matrix.dy);console.debug("Nearest x y : "+_22+" : "+_23);var _24=_22-_21.shape.matrix.dx+(games.Tetravex._props.padding);var _25=_23-_21.shape.matrix.dy+(games.Tetravex._props.padding);if(_24==0&&_25==0){return;}function _26(){_24=games.Tetravex._origin.x-_21.shape.matrix.dx+(games.Tetravex._props.padding);_25=games.Tetravex._origin.y-_21.shape.matrix.dy+(games.Tetravex._props.padding);};for(var g=0;g<games.Tetravex._tile.length;g++){console.debug("Check tile "+g+" x:y  "+games.Tetravex._tile[g].matrix.dx+" : "+games.Tetravex._tile[g].matrix.dx);if(_22==games.Tetravex._tile[g].matrix.dx&&_23==games.Tetravex._tile[g].matrix.dy){_26();}}_21.shape.applyLeftTransform({dx:_24,dy:_25});};games.Tetravex.checkForWin=function(_27){console.debug("check for win");for(var g=0;g<games.Tetravex._tile.length;g++){if(games.Tetravex._tile[g].matrix.dx>games.Tetravex._props.suface_width/2){console.debug("Not Yet!");return;}}for(var g=0;g<games.Tetravex._tile.length;g++){console.debug("&&&&& Check Tile "+g);if(games.Tetravex._tile[g].tileAbove!=null){console.debug(" Tile Above "+games.Tetravex._tile[g].tileAbove);console.debug(" Tile "+g+" topNum "+games.Tetravex._tile[g].topNum);console.debug(" Tile above bottom num "+games.Tetravex._tile[games.Tetravex._tile[g].tileAbove].bottomNum);if(games.Tetravex._tile[g].topNum!=games.Tetravex._tile[games.Tetravex._tile[g].tileAbove].bottomNum){console.debug("The tile above tile "+g+" does not match");return;}}if(games.Tetravex._tile[g].tileRight!=null){console.debug(" Tile to Right "+games.Tetravex._tile[g].tileRight);console.debug(" Tile "+g+" rightNum "+games.Tetravex._tile[g].rightNum);console.debug(" Right Tile left num "+games.Tetravex._tile[games.Tetravex._tile[g].tileRight].leftNum);if(games.Tetravex._tile[g].rightNum!=games.Tetravex._tile[games.Tetravex._tile[g].tileRight].leftNum){console.debug("The tile to the right of tile "+g+" does not match");return;}}if(games.Tetravex._tile[g].tileBelow!=null){console.debug(" Tile to Below "+games.Tetravex._tile[g].tileBelow);console.debug(" Tile "+g+" bottomNum "+games.Tetravex._tile[g].bottomNum);console.debug(" Below tile top num "+games.Tetravex._tile[games.Tetravex._tile[g].tileBelow].topNum);if(games.Tetravex._tile[g].bottomNum!=games.Tetravex._tile[games.Tetravex._tile[g].tileBelow].topNum){console.debug("The tile below tile "+g+" does not match");return;}}if(games.Tetravex._tile[g].tileLeft!=null){console.debug(" Tile to Left "+games.Tetravex._tile[g].tileLeft);console.debug(" Tile "+g+" leftNum "+games.Tetravex._tile[g].leftNum);console.debug(" Left tile right num "+games.Tetravex._tile[games.Tetravex._tile[g].tileLeft].rightNum);if(games.Tetravex._tile[g].leftNum!=games.Tetravex._tile[games.Tetravex._tile[g].tileLeft].rightNum){console.debug("The tile to the left of tile "+g+" does not match");return;}}}console.debug("%%%%%%%%%%%%% Winner Winner Chicken Dinner %%%%%%%%%%%%%%%%%");};games.Tetravex._checkNeighbours=function(_28){console.log("Check neighbour of mover "+_28.shape.tileNumber+" co-ords x:y "+_28.shape.matrix.dx+" : "+_28.shape.matrix.dy);for(var g=0;g<games.Tetravex._tile.length;g++){if(_28.shape.matrix.dx<games.Tetravex._props.suface_width/2){console.debug("Checking y for tile present "+games.Tetravex._findNearestY(_28.shape.matrix.dy-games.Tetravex._tileSize));var _29=games.Tetravex._findNearestY(_28.shape.matrix.dy-games.Tetravex._tileSize);if(games.Tetravex._tile[g].matrix.dy==_29&&_29!=_28.shape.matrix.dy&&games.Tetravex._tile[g].matrix.dx==_28.shape.matrix.dx){console.debug("******* tile above! **********");games.Tetravex._tile[_28.shape.tileNumber].tileAbove=g;if(games.Tetravex._tile[g].bottomNum!=_28.shape.topNum){if(games.Tetravex.easy){}}}console.debug("Checking y for tile present "+games.Tetravex._findNearestY(_28.shape.matrix.dy+games.Tetravex._tileSize));var _29=games.Tetravex._findNearestY(_28.shape.matrix.dy+games.Tetravex._tileSize);if(games.Tetravex._tile[g].matrix.dy==_29&&_29!=_28.shape.matrix.dy&&games.Tetravex._tile[g].matrix.dx==_28.shape.matrix.dx){console.debug("******* tile below! **********");games.Tetravex._tile[_28.shape.tileNumber].tileBelow=g;if(games.Tetravex._tile[g].topNum!=_28.shape.bottomNum){if(games.Tetravex.easy){}}}console.debug("Checking x for tile present "+games.Tetravex._findNearestX(_28.shape.matrix.dx-games.Tetravex._tileSize));var _2a=games.Tetravex._findNearestX(_28.shape.matrix.dx-games.Tetravex._tileSize);if(games.Tetravex._tile[g].matrix.dx==_2a&&_2a!=_28.shape.matrix.dx&&games.Tetravex._tile[g].matrix.dy==_28.shape.matrix.dy){console.debug("******* tile to the left! ********** mover"+_28.shape.tileNumber+" tile "+games.Tetravex._tile[g].tileNumber);games.Tetravex._tile[_28.shape.tileNumber].tileLeft=g;if(games.Tetravex._tile[g].rightNum!=_28.shape.leftNum){if(games.Tetravex.easy){}}}console.debug("Checking x for tile present "+games.Tetravex._findNearestX(_28.shape.matrix.dx+games.Tetravex._tileSize));var _2a=games.Tetravex._findNearestX(_28.shape.matrix.dx+games.Tetravex._tileSize);if(games.Tetravex._tile[g].matrix.dx==_2a&&_2a!=_28.shape.matrix.dx&&games.Tetravex._tile[g].matrix.dy==_28.shape.matrix.dy){console.debug("******* tile to the right! **********");games.Tetravex._tile[_28.shape.tileNumber].tileRight=g;if(games.Tetravex._tile[g].leftNum!=_28.shape.rightNum){if(games.Tetravex.easy){}}}}}};games.Tetravex._findNearestY=function(_2b){if(_2b<=(games.Tetravex._boardY[0]+games.Tetravex._half_square)){return games.Tetravex._boardY[0];}for(var i=1;i<=games.Tetravex._boardSize-2;i++){var _2c=games.Tetravex._boardY[i]-games.Tetravex._half_square;var _2d=games.Tetravex._boardY[i]+games.Tetravex._half_square;if(_2d>=_2b&&_2b>_2c){return games.Tetravex._boardY[i];}}return games.Tetravex._boardY[games.Tetravex._boardSize-1];};games.Tetravex._findNearestX=function(_2e){if(_2e<=games.Tetravex._boardX[0]+games.Tetravex._half_square){return games.Tetravex._boardX[0];}for(var p=1;p<=(games.Tetravex._boardSize*2)-1;p++){var f=0;var _2f=games.Tetravex._boardX[p]+games.Tetravex._half_square;var _30=games.Tetravex._boardX[p]-games.Tetravex._half_square;if(p==games.Tetravex._boardSize){_2f=games.Tetravex._boardX[p]+(games.Tetravex._props.padding);f=1;}if(p==games.Tetravex._boardSize+1){_30=games.Tetravex._boardX[p]-games.Tetravex._half_square-games.Tetravex._tileSize-(games.Tetravex._props.padding);}if((_2f>=_2e)&&(_2e>_30)){return games.Tetravex._boardX[p-f];}}return games.Tetravex._boardX[games.Tetravex._boardSize*2];};